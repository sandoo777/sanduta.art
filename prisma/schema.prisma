// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  VIEWER
}

enum CustomerSource {
  ONLINE
  OFFLINE
}

enum OrderSource {
  ONLINE
  OFFLINE
}

enum OrderChannel {
  WEB
  PHONE
  WALK_IN
  EMAIL
}

enum OrderStatus {
  PENDING
  IN_PREPRODUCTION
  IN_DESIGN
  IN_PRODUCTION
  IN_PRINTING
  QUALITY_CHECK
  READY_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ProductionStatus {
  PENDING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELED
}

enum ProductionPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  ORDER
  PROJECT
  FILE
  SYSTEM
}

enum ActivityType {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
  SESSION_REVOKED
  FAILED_LOGIN
  NEW_DEVICE
}

enum Language {
  RO
  EN
  RU
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum EditorUnit {
  PX
  MM
  CM
}

enum UIDensity {
  COMPACT
  STANDARD
  SPACIOUS
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(OPERATOR)
  active        Boolean   @default(true)
  emailVerified DateTime?
  image         String?
  phone         String?
  company       String?
  cui           String?
  
  // Two-Factor Authentication
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String?
  backupCodes      String[]  @default([])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  orders         Order[]
  assignedOrders Order[]          @relation("AssignedOrders")
  customerNotes  CustomerNote[]   @relation("CustomerNotes")
  productionJobs ProductionJob[]  @relation("AssignedProductionJobs")
  editorProjects EditorProject[]
  userFiles      UserFile[]
  projectFolders ProjectFolder[]
  addresses      Address[]
  notifications  Notification[]
  userSessions   UserSession[]
  securityActivity SecurityActivity[]
  preferences    UserPreferences?
  orderTimeline  OrderTimeline[]  @relation("OrderTimelineEvents")
  orderNotes     OrderNote[]      @relation("OrderNotes")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?   @db.Text
  image       String?   // URL imagine categorie
  color       String?   @default("#3B82F6")
  icon        String?   @default("ðŸ“¦")
  
  // Ierarhie categorii (parent-child pentru subcategorii)
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryHierarchy")
  
  // Management vizibilitate È™i ordine
  order       Int       @default(0)  // Ordinea de afiÈ™are
  active      Boolean   @default(true)  // Status activ/inactiv
  featured    Boolean   @default(false) // Categorie featured pentru homepage
  
  // SEO È™i metadata
  metaTitle       String?
  metaDescription String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@unique([name, parentId]) // Nume unic Ã®n cadrul aceluiaÈ™i pÄƒrinte
  @@index([parentId])
  @@index([slug])
  @@index([active])
  @@index([order])
  @@map("categories")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  sku         String?     @unique
  description String?     @db.Text
  descriptionShort String? @db.Text
  type        ProductType @default(STANDARD)
  price       Decimal     @default(0) @db.Decimal(10, 2)
  categoryId  String
  active      Boolean     @default(true)
  metaTitle       String?
  metaDescription String?
  ogImage         String?
  options         Json?
  dimensions      Json?
  pricing         Json?
  production      Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  category    Category         @relation(fields: [categoryId], references: [id])
  images      ProductImage[]
  variants    ProductVariant[]
  orderItems  OrderItem[]
  materials   ProductMaterial[]
  printMethods ProductPrintMethod[]
  finishing   ProductFinishing[]
  editorProjects EditorProject[]

  @@index([categoryId])
  @@index([slug])
  @@index([createdAt])
  @@index([active])
  @@map("products")
}

enum ProductType {
  STANDARD
  CONFIGURABLE
  CUSTOM
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  name      String
  price     Decimal  @default(0) @db.Decimal(10, 2)
  stock     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variants")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductMaterial {
  id            String   @id @default(cuid())
  productId     String
  materialId    String
  priceModifier Decimal? @db.Decimal(10, 2)
  createdAt     DateTime @default(now())

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([productId, materialId])
  @@map("product_materials")
}

model ProductPrintMethod {
  id            String   @id @default(cuid())
  productId     String
  printMethodId String
  createdAt     DateTime @default(now())

  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  printMethod PrintMethod @relation(fields: [printMethodId], references: [id], onDelete: Cascade)

  @@unique([productId, printMethodId])
  @@map("product_print_methods")
}

model ProductFinishing {
  id           String   @id @default(cuid())
  productId    String
  finishingId  String
  priceModifier Decimal? @db.Decimal(10, 2)
  createdAt    DateTime @default(now())

  product   Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  finishing FinishingOperation @relation(fields: [finishingId], references: [id], onDelete: Cascade)

  @@unique([productId, finishingId])
  @@map("product_finishing")
}

model Customer {
  id        String         @id @default(cuid())
  name      String
  email     String         @unique
  phone     String?
  address   String?
  city      String?
  country   String?        @default("Moldova")
  company   String?
  source    CustomerSource @default(ONLINE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @default(now()) @updatedAt

  orders Order[]
  notes  CustomerNote[]
  tags   CustomerTag[]

  @@map("customers")
}

model CustomerNote {
  id          String   @id @default(cuid())
  customerId  String
  content     String   @db.Text
  createdById String
  createdAt   DateTime @default(now())

  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdBy User     @relation("CustomerNotes", fields: [createdById], references: [id])

  @@map("customer_notes")
}

model CustomerTag {
  id         String   @id @default(cuid())
  customerId String
  label      String
  color      String   @default("#3B82F6")
  createdAt  DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_tags")
}

model Order {
  id                   String        @id @default(cuid())
  orderNumber          String?       @unique // NumÄƒr comandÄƒ unic pentru clienÈ›i
  customerId           String?
  customerName         String
  customerEmail        String
  customerPhone        String?
  source               OrderSource   @default(ONLINE)
  channel              OrderChannel  @default(WEB)
  status               OrderStatus   @default(PENDING)
  paymentStatus        PaymentStatus @default(PENDING)
  paymentMethod        String?       // card, cash, bank_transfer
  deliveryStatus       String        @default("pending") // pending, shipped, delivered
  deliveryMethod       String?       // novaposhta, courier, pickup
  deliveryAddress      String?
  city                 String?
  country              String?       // Èšara pentru adresÄƒ
  postalCode           String?       // Cod poÈ™tal
  novaPoshtaWarehouse  String?
  trackingNumber       String?
  paynetSessionId      String?
  totalPrice           Decimal       @default(0) @db.Decimal(10, 2)
  subtotal             Decimal?      @db.Decimal(10, 2) // Subtotal fÄƒrÄƒ taxe
  discount             Decimal?      @default(0) @db.Decimal(10, 2) // Discount aplicat
  vat                  Decimal?      @db.Decimal(10, 2) // TVA
  shippingCost         Decimal?      @default(0) @db.Decimal(10, 2) // Cost livrare
  currency             String        @default("MDL")
  dueDate              DateTime?
  internalNotes        String?       @db.Text // Note interne despre comandÄƒ (renumit)
  companyName          String?       // Pentru comenzi B2B
  taxId                String?       // CUI/VAT pentru firme
  userId               String?
  assignedToUserId     String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @default(now()) @updatedAt

  customer       Customer?       @relation(fields: [customerId], references: [id])
  user           User?           @relation(fields: [userId], references: [id])
  assignedTo     User?           @relation("AssignedOrders", fields: [assignedToUserId], references: [id])
  orderItems     OrderItem[]
  files          OrderFile[]
  productionJobs ProductionJob[]
  timeline       OrderTimeline[]
  notes          OrderNote[]

  @@index([userId])
  @@index([customerId])
  @@index([customerEmail])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([assignedToUserId])
  @@map("orders")
}

model OrderTimeline {
  id          String   @id @default(cuid())
  orderId     String
  eventType   String   // status_change, payment_update, note_added, file_uploaded, etc.
  eventData   Json?    // Additional event data (old status, new status, etc.)
  description String   // Human-readable description
  createdById String?  // User who triggered the event
  createdAt   DateTime @default(now())

  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdBy User? @relation("OrderTimelineEvents", fields: [createdById], references: [id])

  @@index([orderId])
  @@index([createdAt])
  @@index([eventType])
  @@map("order_timeline")
}

model OrderNote {
  id          String   @id @default(cuid())
  orderId     String
  content     String   @db.Text
  isInternal  Boolean  @default(true)  // true = note internal, false = note vizibilÄƒ pentru client
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  createdBy User  @relation("OrderNotes", fields: [createdById], references: [id])

  @@index([orderId])
  @@index([createdAt])
  @@index([isInternal])
  @@map("order_notes")
}

model OrderItem {
  id                String  @id @default(cuid())
  orderId           String
  productId         String
  variantId         String?
  customDescription String?
  quantity          Int     @default(1)
  unitPrice         Decimal @default(0) @db.Decimal(10, 2)
  lineTotal         Decimal @default(0) @db.Decimal(10, 2)
  
  // Editor integration fields
  projectId      String? // Link to EditorProject
  previewImage   String? // Project preview URL
  finalFileUrl   String? // Final file for printing
  configuration  Json?   // Configurator selections
  specifications Json?   // Product specifications (dimensions, material, etc.)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model OrderFile {
  id        String   @id @default(cuid())
  orderId   String
  url       String
  name      String
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_files")
}

model ProductionJob {
  id           String             @id @default(cuid())
  orderId      String
  name         String
  status       ProductionStatus   @default(PENDING)
  priority     ProductionPriority @default(NORMAL)
  assignedToId String?
  startedAt    DateTime?
  completedAt  DateTime?
  dueDate      DateTime?
  notes        String?            @db.Text
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  assignedTo      User?           @relation("AssignedProductionJobs", fields: [assignedToId], references: [id])
  materialUsages  MaterialUsage[]

  @@map("production_jobs")
}

model Material {
  id          String          @id @default(cuid())
  name        String
  sku         String?         @unique
  unit        String          // ex: "kg", "m2", "ml", "pcs"
  stock       Float           @default(0)
  minStock    Float           @default(0)   // alert threshold
  costPerUnit Decimal         @default(0) @db.Decimal(10, 2)
  notes       String?         @db.Text
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  consumption MaterialUsage[]
  productMaterials ProductMaterial[]

  @@map("materials")
}

model MaterialUsage {
  id         String        @id @default(cuid())
  materialId String
  jobId      String
  quantity   Float
  createdAt  DateTime      @default(now())

  material Material       @relation(fields: [materialId], references: [id], onDelete: Cascade)
  job      ProductionJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("material_usages")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model EditorProject {
  id         String   @id @default(cuid())
  name       String
  userId     String
  productId  String?  // Link to Product
  data       String   @db.Text  // JSON stringified project data
  layers     Json?    // Layer structure for validation
  metadata   Json?    // Dimensions, bleed, DPI, etc.
  thumbnail  String?
  previewImage String? // Final preview URL
  finalFile  String?  // Final file URL for printing
  status     String   @default("draft") // draft, saved, validated
  folderId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  folder  ProjectFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([productId])
  @@index([folderId])
  @@map("editor_projects")
}

model ProjectFolder {
  id        String   @id @default(cuid())
  name      String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects EditorProject[]

  @@index([userId])
  @@map("project_folders")
}

model UserFile {
  id           String      @id @default(cuid())
  userId       String
  name         String
  type         String
  size         Int
  thumbnailUrl String?
  previewUrl   String?
  originalUrl  String
  lastUsedAt   DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions FileVersion[]

  @@index([userId])
  @@map("user_files")
}

model FileVersion {
  id        String   @id @default(cuid())
  fileId    String
  variant   String   // original, preview, print_ready, editor
  format    String
  size      Int
  url       String
  createdAt DateTime @default(now())
  metadata  Json?

  file UserFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@map("file_versions")
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  name       String
  phone      String
  address    String
  city       String
  country    String   @default("Moldova")
  postalCode String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  archived  Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([userId, archived])
  @@map("notifications")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  deviceName   String?
  browser      String?
  os           String?
  ipAddress    String?
  location     String?
  isActive     Boolean  @default(true)
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, isActive])
  @@index([sessionToken])
  @@map("user_sessions")
}

model SecurityActivity {
  id          String       @id @default(cuid())
  userId      String
  type        ActivityType
  description String
  ipAddress   String?
  userAgent   String?
  location    String?
  success     Boolean      @default(true)
  createdAt   DateTime     @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, createdAt])
  @@map("security_activity")
}

model UserPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  
  // Language & Theme
  language  Language @default(RO)
  theme     Theme    @default(SYSTEM)
  
  // Notifications
  emailOrders        Boolean @default(true)
  emailProjects      Boolean @default(true)
  emailFiles         Boolean @default(true)
  emailPromotions    Boolean @default(false)
  pushNotifications  Boolean @default(true)
  inAppNotifications Boolean @default(true)
  
  // Editor Preferences
  editorSnapToGrid    Boolean    @default(true)
  editorGridVisible   Boolean    @default(true)
  editorGridSize      Int        @default(10)
  editorUnit          EditorUnit @default(PX)
  editorAutoSave      Int        @default(10) // seconds
  editorUIDensity     UIDensity  @default(STANDARD)
  
  // Configurator Preferences
  configDefaultQuantity       Int    @default(1)
  configDefaultProductionTime String @default("standard")
  configDefaultDelivery       String @default("courier")
  configDefaultPayment        String @default("card")
  
  // Communications & Marketing
  newsletter              Boolean @default(false)
  specialOffers           Boolean @default(false)
  personalizedRecommend   Boolean @default(false)
  productNews             Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("user_preferences")
}

model PrintMethod {
  id               String   @id @default(cuid())
  name             String
  type             String   // Digital, Offset, Inkjet, UV, Latex, Serigrafie, etc.
  costPerM2        Decimal? @db.Decimal(10, 2)
  costPerSheet     Decimal? @db.Decimal(10, 2)
  speed            String?  // Viteza de producÈ›ie (ex: "100 mÂ²/orÄƒ")
  maxWidth         Int?     // Ã®n mm
  maxHeight        Int?     // Ã®n mm
  description      String?  @db.Text
  active           Boolean  @default(true)
  materialIds      String[] @default([]) // IDs materiale compatibile
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  productPrintMethods ProductPrintMethod[]

  @@map("print_methods")
}

model FinishingOperation {
  id                      String   @id @default(cuid())
  name                    String
  type                    String   // TÄƒiere, Laminare, BÄƒgÄƒuire, Capsare, etc.
  costFix                 Decimal? @db.Decimal(10, 2)
  costPerUnit             Decimal? @db.Decimal(10, 2)
  costPerM2               Decimal? @db.Decimal(10, 2)
  timeSeconds             Int?     // Timp execuÈ›ie Ã®n secunde
  compatibleMaterialIds   String[] @default([]) // IDs materiale compatibile
  compatiblePrintMethodIds String[] @default([]) // IDs metode tipÄƒrire compatibile
  description             String?  @db.Text
  active                  Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  productFinishing ProductFinishing[]

  @@map("finishing_operations")
}

model Machine {
  id                       String   @id @default(cuid())
  name                     String
  type                     String   // Digital Printer, Offset Press, Large Format, etc.
  costPerHour              Decimal? @db.Decimal(10, 2)
  speed                    String?  // ex: "100 ppm", "50 mÂ²/orÄƒ"
  maxWidth                 Int?     // Ã®n mm
  maxHeight                Int?     // Ã®n mm
  compatibleMaterialIds    String[] @default([]) // IDs materiale compatibile
  compatiblePrintMethodIds String[] @default([]) // IDs metode tipÄƒrire compatibile
  description              String?  @db.Text
  active                   Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("machines")
}
